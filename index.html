<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ruzgar</title>
    <!-- Move styles to separate CSS file -->
    <link rel="stylesheet" href=" ./src/styles/main.css">
</head>
<body>
    <!-- Menu bar at document level -->
    <div class="menu-bar">
        <button class="menu-button cycle-text" data-form="addNode">Add Value</button>
        <button class="menu-button" data-form="revealQR">Add Contributor</button>
    </div>

    <!-- Main visualization container -->
    <div class="visualization-container">
        <div id="treemap-container"></div>
        <div id="pie-container"></div>
    </div>

    <!-- Popup forms container at document level -->
    <div class="node-popup">
        <div class="node-popup-content">
            <!-- Add Node Form -->
            <form id="addNodeForm" class="popup-form">
                <h2>Add New Node</h2>
                <div class="form-group">
                    <label for="nodeName">Name:</label>
                    <input type="text" id="nodeName" required>
                </div>
                <div id="percentageGroup" class="form-group" style="display: none;">
                    <label for="nodePercentage">Desired Percentage:</label>
                    <input type="range" id="nodePercentage" min="1" max="100" value="10">
                    <output for="nodePercentage">10%</output>
                </div>
                <div class="form-buttons">
                    <button type="submit" class="primary">Add Node</button>
                    <button type="button" class="cancel">Cancel</button>
                </div>
            </form>

            <!-- Reveal QR Form -->
            <form id="revealQRForm" class="popup-form" style="display: none;">
                <h2>Your Public Key</h2>
                <div class="qr-display">
                    <div id="qr-code"></div>
                    <div id="public-key-text"></div>
                </div>
                <div class="form-buttons">
                    <button type="button" class="copy-key">Copy Key</button>
                    <button type="button" class="cancel">Close</button>
                </div>
            </form>
        </div>
    </div>

    <!-- External Dependencies -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script type="importmap">
    {
        "imports": {
            "d3": "https://cdn.jsdelivr.net/npm/d3@7/+esm"
        }
    }
    </script>

    <!-- Remove the old script tags for d3 and qrcode -->

    <script type="module">
        import { App } from './src/App.js';
        import { D3Node } from './src/models/D3Node.js';

        // Initialize data structure
        const environmentalist = new D3Node('environmentalist');
        const clownsWithoutBorders = new D3Node('clowns4all', null, [environmentalist]);
        const researcher = new D3Node('researcher', null, [environmentalist]);
        const educator = new D3Node('educator', null, [environmentalist]);

        // Our main nodes with multiple types
        const whalewatch = new D3Node('whalewatch', null, [clownsWithoutBorders]);  // is a contributor
        const alice = new D3Node('alice', null, [researcher]);  // is a contributor

        const ruzgar = new D3Node('ruzgar', null, []);

        // 1. Material Needs & Dependencies
        const space = ruzgar.addChild("Space & Environment", 25);

        // Space & Environment children
        const indoorSpace = space.addChild("Indoor/Outdoor Space", 15);
        const seating = space.addChild("Comfortable Seating", 15);
        const lighting = space.addChild("Lighting", 12);
        const temperature = space.addChild("Temperature Control", 12);
        const bathroom = space.addChild("Bathroom Access", 12);
        const waterAccess = space.addChild("Water Access", 12);
        const cleaning = space.addChild("Cleaning Supplies", 11);
        const waste = space.addChild("Trash/Recycling", 11);

        console.log(ruzgar);
        
        const hosts = indoorSpace.addChild("Space Providers/Hosts", 14);

        // Main Categories with their percentage weights
        const infrastructure = ruzgar.addChild("Infra(de)structure & Bottom-secret Spaces", 25);
        const magicalTech = ruzgar.addChild("Magical Technologies & Systems", 25);
        const substances = ruzgar.addChild("Transformative Substances", 20);
        const realityHacking = ruzgar.addChild("Reality Hacking & Manifestation", 20);
        const loreSystem = ruzgar.addChild("Lore & Knowledge Systems", 10);

        // Underground Networks contributions
        const secretStairs = infrastructure.addChild("Secret stairways", 10, [alice]);
        const wellsTunnels = infrastructure.addChild("Wells & tunnels", 8, [clownsWithoutBorders]);
        const basements = infrastructure.addChild("Basements", 7, [alice]);
        const subLakes = infrastructure.addChild("Subterranean lakes", 6, [alice]);

        // Hidden Passages contributions
        const alleysRoots = infrastructure.addChild("Alleys & Roots", 9, [alice]);
        const trapDoors = infrastructure.addChild("Trap-doors", 8, [clownsWithoutBorders]);
        const warpZones = infrastructure.addChild("Warp zones", 7, [whalewatch]);

        // Alternative Venues contributions
        const driveIns = infrastructure.addChild("Liberation Drive-ins", 8, [alice]);
        const trainYards = infrastructure.addChild("Train-yards", 7, [whalewatch]);
        const fleaMarkets = infrastructure.addChild("Flea Markets", 6, [alice]);
        const roofs = infrastructure.addChild("Roofs", 5, [whalewatch]);
        const ufoLanding = infrastructure.addChild("*ufo* Landing Pads", 5, [clownsWithoutBorders]);

        // Reality Manipulation contributions
        const cloudBusting = magicalTech.addChild("Cloud Busting", 9, [alice]);
        const cameraAbatement = magicalTech.addChild("Camera Abatement", 8, [whalewatch]);
        const systemOfframp = magicalTech.addChild("System (off/out)-ramp Drive-thrus", 7, [alice]);

        // Mystical Operations contributions
        const bioSlimes = magicalTech.addChild("Bioluminescent Slimes", 8, [alice]);
        const butterflyWings = magicalTech.addChild("Butterfly-wing-iridescence Materiality", 8, [whalewatch]); 
        const eventHorizons = magicalTech.addChild("Event Horizons & Vanishing Points", 7, [clownsWithoutBorders]);

        // Sacred Knowledge contributions
        const libraryStacks = magicalTech.addChild("Library Stacks", 8, [alice]);
        const saunaLore = magicalTech.addChild("Pagan Sauna Lore", 7, [whalewatch]);
        const ritualSpaces = magicalTech.addChild("Ritual Spaces", 6, [alice]);
        const candyWisdom = magicalTech.addChild("Candy Store Wisdom", 6, [whalewatch]);

        // Magical Materials contributions
        const pixieDust = substances.addChild("Pixie Dust & Silly Powders", 9, [alice]);
        const oozeSlimes = substances.addChild("Oozes & slimes", 8, [whalewatch]);
        const potionsBalms = substances.addChild("Potions & Balms", 7, [alice]);

        // Alchemical Mixtures contributions
        const veganWaters = substances.addChild("Vegan & Non-vegan Waters", 8, [alice]);
        const mistsSprays = substances.addChild("Mists & Sprays", 7, [whalewatch]);
        const lozengesBonbons = substances.addChild("Lozenges & Bonbons", 6, [alice]);

        // Special Effects contributions
        const pheromones = substances.addChild("Pheromonal Inflection Points", 8, [alice, researcher]);
        const darkMatter = substances.addChild("Dark Matter Manipulation", 7, [whalewatch, clownsWithoutBorders]);
        const globulation = substances.addChild("Nebulatory Coagular Globulation", 6, [alice, educator]);

        // Reality Scripts contributions
        const trueFakes = realityHacking.addChild("TrueFakes & FakeUntruths", 9, [alice, researcher]);
        const memeDrives = realityHacking.addChild("MemeDrives & GeneEngines", 8, [whalewatch, clownsWithoutBorders]);
        const cosmicBabble = realityHacking.addChild("Cosmic Psychobabble", 7, [alice, educator]);

        // Dimensional Engineering contributions
        const dimPortals = realityHacking.addChild("Interdimensional portals", 8, [alice, researcher]);
        const infinityPools = realityHacking.addChild("Infinity Pools", 7, [whalewatch, clownsWithoutBorders]);
        const deprivationTanks = realityHacking.addChild("Sensory Deprivation Tankage", 6, [alice, educator]);

        // Mathematical Magic contributions
        const girlMath = realityHacking.addChild("GirlMath", 8, [alice, researcher]);
        const moonMath = realityHacking.addChild("Moonlight Mathematicians", 7, [whalewatch, clownsWithoutBorders]);
        const angelicNums = realityHacking.addChild("Angelic Numbers", 6, [alice, educator]);

        // Narrative Crafting contributions
        const comicBooks = loreSystem.addChild("Comic Books & Stories", 8, [alice, researcher]);
        const poemsAndMaps = loreSystem.addChild("Poems & Maps", 7, [whalewatch, clownsWithoutBorders]);

        // Wisdom Keepers contributions
        const priestesses = loreSystem.addChild("Interdimensional Priestesses", 8, [alice, researcher]);
        const crimeLords = loreSystem.addChild("Alien Crime Lords", 7, [whalewatch, clownsWithoutBorders]);
        const ballerinas = loreSystem.addChild("Sci-fi Ballerinas", 6, [alice, educator]);



        // whalewatch's recognition of ruzgar
        const whalewatchgive = whalewatch.addChild('ðŸŒ³ give', 80);
        const whalewatchpotential = whalewatchgive.addChild('ðŸ”® potential', 40);
        const ruzgarInwhalewatchpotential = whalewatchpotential.addChild('ruzgar', 15, [ruzgar]);

        // alice's recognition of ruzgar
        const alicegive = alice.addChild('ðŸŒ³ give', 80);
        const alicepotential = alicegive.addChild('ðŸ”® potential', 40);
        const ruzgarInalicepotential = alicepotential.addChild('ruzgar', 15, [ruzgar]);

        // clownsWithoutBorders's recognition of ruzgar
        const clownsWithoutBordersgive = clownsWithoutBorders.addChild('ðŸŒ³ give', 80);
        const clownsWithoutBorderspotential = clownsWithoutBordersgive.addChild('ðŸ”® potential', 40);
        const ruzgarInclownsWithoutBorderspotential = clownsWithoutBorderspotential.addChild('ruzgar', 15, [ruzgar]);

        // Calculate shares at different type levels
        console.log('\nShares by type level:');
        console.log('Environmentalist share:', ruzgar.shareOfGeneralContribution(environmentalist));
        console.log('clownsWithoutBorders share:', ruzgar.shareOfGeneralContribution(clownsWithoutBorders));
        console.log('Educator share:', ruzgar.shareOfGeneralContribution(educator));
        console.log('Researcher share:', ruzgar.shareOfGeneralContribution(researcher));
        console.log('whalewatch specific share:', ruzgar.shareOfGeneralContribution(whalewatch));
        console.log('alice specific share:', ruzgar.shareOfGeneralContribution(alice));

        // Calculate mutual recognition and generalMutualContribution
        console.log('\nMutual Recognition:');
        console.log('With whalewatch:', ruzgar.mutualShareOfGeneralContribution(whalewatch));
        console.log('\nFinal mutualGeneralContribution:');
        console.log(ruzgar.mutualGeneralContribution());
        console.log(ruzgar);

        // Initialize app
        const app = new App(ruzgar);

        // Setup UI interactions
        const addNodeTexts = ['Add Value', 'Add Goal', 'Add Dependency', 'Add Desire'];
        let currentTextIndex = 0;

        // Menu button handlers
        $('.menu-button').on('click', function() {
            const formId = $(this).data('form');
            $('.popup-form').hide();
            $(`#${formId}Form`).show();
            $('.node-popup').addClass('active');

            if (formId === 'addNode') {
                const hasChildren = app.currentView.data.children.size > 0;
                $('#percentageGroup').toggle(hasChildren);
            }

            if (formId === 'revealQR') {
                generateQRCode();
            }
        });

        // Form submission handler
        $('#addNodeForm').on('submit', function(e) {
            e.preventDefault();
            const name = $('#nodeName').val();
            const currentViewData = app.currentViewData;
            console.log('Form submission - currentViewData:', currentViewData.name);  // Debug log
            console.log('Form submission - currentView:', app.currentView.data.name);  // Debug log
            
            const hasChildren = currentViewData.children.size > 0;
            const percentage = hasChildren ? Number($('#nodePercentage').val()) : 100;
            
            if (hasChildren && (percentage <= 0 || percentage >= 100)) {
                alert('Percentage must be between 1 and 99');
                return;
            }
            
            const currentTotal = currentViewData.totalChildPoints || currentViewData.points || 100;
            const points = hasChildren ? 
                Math.max(1, Math.ceil(currentTotal / (1 - percentage/100)) - currentTotal) : 
                currentTotal;
            
            console.log('Adding node to:', currentViewData.name);  // Debug log
            const newChild = currentViewData.addChild(name, points);
            
            // Update visualizations
            app.updateVisualizations();
            
            // Close and reset form
            $('.node-popup').removeClass('active');
            this.reset();
        });

        // Cycle text button
        $('.cycle-text').on('click', function() {
            currentTextIndex = (currentTextIndex + 1) % addNodeTexts.length;
            $(this).text(addNodeTexts[currentTextIndex]);
            $('#addNodeForm h2').text(addNodeTexts[currentTextIndex]);
        });

        // Range input handler
        $('#nodePercentage').on('input', function() {
            $(this).next('output').text($(this).val() + '%');
        });

        // Cancel buttons
        $('.cancel').on('click', function() {
            $('.node-popup').removeClass('active');
            $('#addNodeForm')[0].reset();
        });

        // Copy key handler
        $('.copy-key').on('click', function() {
            const publicKey = $('#public-key-text').text();
            navigator.clipboard.writeText(publicKey)
                .then(() => alert('Public key copied to clipboard!'));
        });

        function generateQRCode() {
            const mockPublicKey = "0x742d35Cc6634C0532925a3b844Bc454e4438f44e";
            $('#qr-code').empty();
            new QRCode(document.getElementById("qr-code"), {
                text: mockPublicKey,
                width: 200,
                height: 200,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H,
                useSVG: true
            });
            $('#public-key-text').text(mockPublicKey);
        }
    </script>
</body>
</html> 